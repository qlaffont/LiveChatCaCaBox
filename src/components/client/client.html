<html>

<head>
  <title>LiveChatCCB</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"
    integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
    crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
  <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />
  <script src="https://cdn.vidstack.io/player@1.12.13" type="module"></script>
  <style>
    media-player.is-short {
      aspect-ratio: 9 / 16;
    }
  </style>
</head>

<body>
  <div class="absolute top-3 left-3 hidden flex-col items-center z-50" id="author-block">
    <div class="w-fit">
      <div class="border-4 rounded-full border-[#57F287] inline-block">
        <img id="author-img" src="" class="w-full h-full max-w-[70px] max-h-[70px] rounded-full" />
      </div>
    </div>
    <div>
      <p id="author-username" class="text-center font-medium text-white text-lg max-w-[100px]"
        style="text-shadow: #57F287 1px 0 10px;"></p>
    </div>
  </div>

  <div class="absolute w-screen h-screen flex items-end justify-center top-0 left-0 z-20 px-5 pb-5">
    <div>
      <p id="message-text" class="text-white text-5xl font-medium text-center" style="text-shadow:white 1px 0 10px;">
      </p>
    </div>
  </div>

  <div class="absolute max-w-screen max-h-screen h-full w-full flex items-center justify-center top-0 left-0">
    <div id="message-block">
    </div>
  </div>

  <script>
    function generateImg(src, displayFull) {
      return '<img id="message-img" ' + (displayFull ? 'class="aspect-auto w-full h-full max-w-[100vw] max-h-[100vh]"' : '') + ' src="' + src + '" />';
    }

    function generateAudioVideo(src, displayFull, mediaIsShort, contentType) {
      // Use src object format if checking for specific types, or just let vidstack handle it.
      // Vidstack <media-player> accepts src as string or object { src: string, type: string }
      // We'll construct the src attribute value carefully.
      // Actually, standard HTML attribute is just string.
      // To pass type hint, we should use property binding if using framework, or just set it via JS.
      // But standard way for custom elements often supports JSON in attribute or just sniffing.
      // Let's try passing it via src attribute as JSON string if simple string fails, OR
      // simpler: just rely on the server sending correct content-type header which we fixed.
      // BUT, let's try to set the type attribute if it helps.
      // The most robust way with vidstack is strictly relying on the file extension OR the server header.
      // Since we fixed the header to video/mp4, the browser WILL verify it.

      // However, to be extra safe, let's inject the type hint by appending it to the media-provider if possible? No.

      // Let's use the standard `src` attribute. If the server sends `video/mp4`, the browser should be happy.
      // Detailed fix: The user mentioned .mov fails from web.
      // Let's TRY to append a dummy '.mp4' extension to the URL if it doesn't have one, 
      // which might help some players that sniff URL extension.
      // const safeSrc = src.includes('?') ? src + '&ext=.mp4' : src + '?.mp4'; 
      // Actually, let's just use the server implementation and TRUST it first.

      return '<media-player id="message-player" ' + (displayFull ? "class='h-[100vh] " + (mediaIsShort ? "is-short mx-auto" : "aspect-contain w-[100vw] ") + "'" : "class='aspect-contain " + (mediaIsShort ? "is-short" : "") + "'") + ' src="' + src + '" autoplay>' +
        '<media-provider></media-provider>' +
        '<media-audio-layout></media-audio-layout>' +
        '<media-video-layout></media-video-layout>' +
        '</media-player>';
    }

    function displayAuthor(authorUsername, authorPictureURL) {
      var elementBlock = document.getElementById('author-block');
      var elementUsername = document.getElementById('author-username');
      var elementImg = document.getElementById('author-img');

      elementBlock.style.display = 'none';

      elementUsername.innerHTML = authorUsername;
      // Display default image if user doesn't have an image
      elementImg.src = authorPictureURL || 'https://archive.org/download/discordprofilepictures/discordblue.png';

      if (authorUsername || authorPictureURL) {
        elementBlock.style.display = 'flex';
      }
    }

    function displayText(text) {
      var element = document.getElementById('message-text');
      element.style.display = 'none';

      if (text) {
        element.innerHTML = text;
        element.style.display = 'block';
      }
    }

    function displayContent(data) {
      var element = document.getElementById('message-block');

      element.innerHTML = '';

      // Reset styles first
      element.style = '';

      // Apply Layout if present
      if (data.layout) {
        element.style.position = 'absolute';
        element.style.left = data.layout.x + '%';
        element.style.top = data.layout.y + '%';
        element.style.width = data.layout.w + '%';
        element.style.height = data.layout.h + '%';
      }

      var contentHtml = '';
      if (data.mediaContentType) {
        // If layout is active, we force "full" display inside the container
        const isLayoutActive = !!data.layout;
        const shouldUseFull = data.displayFull || isLayoutActive;

        if (data.mediaContentType.indexOf('image') === 0) {
          // For images, if layout is active, ensure it fills the container
          contentHtml = generateImg(data.media || data.url, shouldUseFull);
          if (isLayoutActive) {
            // Patch the generated string to ensure w-full h-full
            contentHtml = contentHtml.replace('class="', 'class="w-full h-full object-cover ');
            if (!contentHtml.includes('class="')) contentHtml = contentHtml.replace('<img', '<img class="w-full h-full object-cover"');
          }
        } else if (data.mediaContentType.indexOf('audio') === 0) {
          contentHtml = '<audio autoplay src="' + (data.media || data.url) + '"></audio>';
        } else {
          // For video/audio
          contentHtml = generateAudioVideo(data.media || data.url, shouldUseFull, data.mediaIsShort, data.mediaContentType);
          if (isLayoutActive) {
            // Force player to fill container
            // Replace class attribute content to simplistic w-full h-full
            contentHtml = contentHtml.replace(/class='[^']*'/, "class='w-full h-full !aspect-auto'");
          }
        }
        element.innerHTML = contentHtml;
      }
    }

    var timeout;
    function displayMessage(message) {
      console.debug("New message !", message);
      if (timeout) {
        clearTimeout(timeout);
      }
      if (message.duration) {
        timeout = setTimeout(() => {
          displayMessage({})
        }, (message.duration * 1000) + 100);
      }

      var elementMessage = document.getElementById('message-block');
      var elementBlock = document.getElementById('author-block');
      var elementText = document.getElementById('message-text');
      elementMessage.innerHTML = '';
      elementBlock.style.display = 'none';
      elementText.style.display = 'none';

      displayAuthor(message.author, message.authorImage);

      var data = JSON.parse(message.content || '{}');

      displayText(data.text);
      displayContent(data);
    }

    document.addEventListener("DOMContentLoaded", function () {
      var socket = io({
        'reconnection': true,
        'reconnectionDelay': 1000,
        'reconnectionDelayMax': 1000,
        'reconnectionAttempts': 999
      });

      socket.on('connect', () => {
        //Get query param
        const urlParams = new URLSearchParams(window.location.search);
        const guildId = urlParams.get('guildId') || '1183396070823313418';
        console.log('ðŸ”— Joining room for guild:', guildId);
        socket.emit("join-room", "messages-" + guildId);
      });

      socket.on("new-message", function (data) {
        console.debug(data);
        displayMessage(data);
      });

      socket.on("stop", function (data) {
        console.debug("Media stopped !");
        clearTimeout(timeout);
        displayMessage({});
      });
    });
  </script>
</body>

</html>